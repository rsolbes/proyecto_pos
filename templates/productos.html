{% extends "base.html" %}

{% block title %}Productos - POS{% endblock %}

{% block content %}
<div class="card">
    <h2 class="card-title">üì¶ Gesti√≥n de Productos</h2>

    <div class="form-group" style="margin-bottom: 1.5rem;">
        <label>üîç Buscar Producto:</label>
        <input type="text" id="buscarProducto" placeholder="Buscar por c√≥digo, nombre o categor√≠a..." autocomplete="off">
    </div>

    <table>
        <thead>
            <tr>
                <th>C√≥digo</th>
                <th>Nombre</th>
                <th>Categor√≠a</th>
                <th>Precio Compra</th>
                <th>Precio Venta</th>
                <th>Stock</th>
                <th>M√≠nimo</th>
                <th>Estado</th>
                {% if usuario_rol == 'administrador' %}<th>Acciones</th>{% endif %}
            </tr>
        </thead>
        <tbody id="productosTabla">
            <tr><td colspan="{% if usuario_rol == 'administrador' %}9{% else %}8{% endif %}" style="text-align: center;">Cargando...</td></tr>
        </tbody>
    </table>
</div>

<!-- MODAL EDITAR -->
<div id="modalEditar" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <h2 style="color: #6366f1; margin-bottom: 1.5rem;">‚úèÔ∏è Editar Producto</h2>
        
        <form id="formEditar">
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="editNombre" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Precio Compra ($):</label>
                    <input type="number" id="editPrecioCompra" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Precio Venta ($):</label>
                    <input type="number" id="editPrecioVenta" step="0.01" min="0" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Stock:</label>
                    <input type="number" id="editStock" min="0" required>
                </div>
                <div class="form-group">
                    <label>Stock M√≠nimo:</label>
                    <input type="number" id="editStockMin" min="0" required>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-success">‚úì Guardar</button>
                <button type="button" class="btn" onclick="cerrarModal()" style="background: #94a3b8; color: white;">Cancelar</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const esAdmin = '{{ usuario_rol }}' === 'administrador';
let productosCompleto = [];
let productoEditando = null;

async function cargarProductosTabla() {
    const productos = await hacerRequest('/api/productos');
    productosCompleto = productos || [];
    renderTabla(productosCompleto);
}

function renderTabla(productos) {
    const tabla = document.getElementById('productosTabla');
    tabla.innerHTML = '';

    if (!productos || productos.length === 0) {
        tabla.innerHTML = `<tr><td colspan="${esAdmin ? 9 : 8}" style="text-align: center;">No hay productos</td></tr>`;
        return;
    }

    productos.forEach(p => {
        const estado = p.estado ? '‚úì Activo' : '‚úó Inactivo';
        const alerta = p.stock_actual <= p.stock_minimo ? ' ‚ö†Ô∏è BAJO' : '';
        const fondo = p.stock_actual <= p.stock_minimo ? 'style="background: #fff3cd;"' : '';
        
        let html = `
            <tr ${fondo}>
                <td>${p.codigo_producto}</td>
                <td>${p.nombre_producto}</td>
                <td>${p.nombre_categoria}</td>
                <td>$${p.precio_compra}</td>
                <td>$${p.precio_venta}</td>
                <td>${p.stock_actual}${alerta}</td>
                <td>${p.stock_minimo}</td>
                <td>${estado}</td>
        `;
        
        if (esAdmin) {
            html += `
                <td>
                    <button class="btn btn-primary" onclick="abrirModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">‚úèÔ∏è Editar</button>
                </td>
            `;
        }
        
        html += '</tr>';
        tabla.innerHTML += html;
    });
}

document.getElementById('buscarProducto').addEventListener('input', (e) => {
    const busqueda = e.target.value.toLowerCase();
    
    const filtrados = productosCompleto.filter(p =>
        p.codigo_producto.toLowerCase().includes(busqueda) ||
        p.nombre_producto.toLowerCase().includes(busqueda) ||
        p.nombre_categoria.toLowerCase().includes(busqueda)
    );
    
    renderTabla(filtrados);
});

function abrirModal(producto) {
    if (!esAdmin) {
        mostrarAlerta('No tienes permiso para editar productos', 'danger');
        return;
    }
    
    productoEditando = producto;
    document.getElementById('editNombre').value = producto.nombre_producto;
    document.getElementById('editPrecioCompra').value = producto.precio_compra;
    document.getElementById('editPrecioVenta').value = producto.precio_venta;
    document.getElementById('editStock').value = producto.stock_actual;
    document.getElementById('editStockMin').value = producto.stock_minimo;
    document.getElementById('modalEditar').style.display = 'flex';
}

function cerrarModal() {
    document.getElementById('modalEditar').style.display = 'none';
    productoEditando = null;
}

document.getElementById('formEditar').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!esAdmin) {
        mostrarAlerta('No tienes permiso para editar productos', 'danger');
        return;
    }
    
    const precioCompra = parseFloat(document.getElementById('editPrecioCompra').value);
    const precioVenta = parseFloat(document.getElementById('editPrecioVenta').value);
    const stock = parseInt(document.getElementById('editStock').value);
    
    if (stock < 0) {
        mostrarAlerta('El stock no puede ser negativo', 'danger');
        return;
    }
    
    if (precioCompra < 0 || precioVenta < 0) {
        mostrarAlerta('Los precios no pueden ser negativos', 'danger');
        return;
    }
    
    const datos = {
        codigo_producto: productoEditando.codigo_producto,
        nombre_producto: document.getElementById('editNombre').value,
        id_categoria: productoEditando.id_categoria,
        precio_compra: precioCompra,
        precio_venta: precioVenta,
        stock_actual: stock,
        stock_minimo: parseInt(document.getElementById('editStockMin').value),
        es_actualizacion: true
    };
    
    const resultado = await hacerRequest('/api/productos', 'POST', datos);
    
    if (resultado && resultado.exito) {
        mostrarAlerta('Producto actualizado exitosamente', 'success');
        cerrarModal();
        cargarProductosTabla();
    } else {
        mostrarAlerta(resultado?.error || 'Error al actualizar producto', 'danger');
    }
});

document.addEventListener('DOMContentLoaded', cargarProductosTabla);
</script>
{% endblock %}
